#!/usr/bin/env node
/**
 * API 函数可用性测试脚本
 *
 * 测试内容：
 * 1. 模块导入是否正常
 * 2. 类型定义是否正确
 * 3. 函数签名是否完整
 * 4. 参数类型推断是否准确
 */

import { resolve, dirname } from 'path'
import { fileURLToPath } from 'url'
import { readFileSync, existsSync, readdirSync } from 'fs'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const root = resolve(__dirname, '..')

// 测试结果
const results = {
  passed: [],
  failed: [],
  skipped: []
}

function pass(msg) {
  console.log(`✅ ${msg}`)
  results.passed.push(msg)
}

function fail(msg) {
  console.error(`❌ ${msg}`)
  results.failed.push(msg)
}

function skip(msg) {
  console.log(`⏭️  ${msg}`)
  results.skipped.push(msg)
}

// ========== 测试 1: 检查生成的文件是否存在 ==========

function testGeneratedFilesExist() {
  console.log('\n🔍 测试 1: 检查生成的文件是否存在...')

  const modules = ['reader', 'bookstore', 'admin', 'writer', 'social', 'ai', 'finance', 'notification']

  for (const mod of modules) {
    const apiFile = resolve(root, `src/modules/${mod}/api/generated/${mod}.ts`)
    if (existsSync(apiFile)) {
      pass(`模块 ${mod.toUpperCase()} API 文件存在`)
    } else {
      fail(`模块 ${mod.toUpperCase()} API 文件缺失: ${apiFile}`)
    }
  }
}

// ========== 测试 2: 检查全局类型定义目录 ==========

function testGlobalSchemas() {
  console.log('\n🔍 测试 2: 检查全局类型定义目录...')

  const modelDir = resolve(root, 'src/api/generated/model.ts')

  if (!existsSync(modelDir)) {
    fail(`全局类型定义目录不存在: ${modelDir}`)
    return
  }

  pass(`全局类型定义目录存在: ${modelDir}`)

  // 检查是否有类型定义文件
  let typeCount = 0

  try {
    const files = readdirSync(modelDir)
    typeCount = files.filter(f => f.endsWith('.ts')).length
    pass(`发现 ${typeCount} 个类型定义文件`)
  } catch (e) {
    fail(`无法读取类型定义目录: ${e.message}`)
  }
}

// ========== 测试 3: 检查生成标记 ==========

function testGenerationHeaders() {
  console.log('\n🔍 测试 3: 检查生成标记...')

  const modules = ['reader', 'bookstore', 'admin', 'writer', 'social', 'ai', 'finance', 'notification']

  for (const mod of modules) {
    const apiFile = resolve(root, `src/modules/${mod}/api/generated/${mod}.ts`)

    if (!existsSync(apiFile)) {
      skip(`跳过 ${mod.toUpperCase()} - 文件不存在`)
      continue
    }

    const content = readFileSync(apiFile, 'utf8')
    const firstLines = content.split('\n').slice(0, 5).join('\n')

    if (firstLines.includes('Generated by orval') ||
        firstLines.includes('@generated') ||
        firstLines.includes('DO NOT EDIT')) {
      pass(`${mod.toUpperCase()} 包含正确的生成标记`)
    } else {
      fail(`${mod.toUpperCase()} 缺少生成标记`)
    }
  }
}

// ========== 测试 4: 检查导出的函数 ==========

function testExportedFunctions() {
  console.log('\n🔍 测试 4: 检查导出的函数...')

  const modules = ['reader', 'bookstore', 'admin', 'writer', 'social', 'ai', 'finance', 'notification']

  for (const mod of modules) {
    const apiFile = resolve(root, `src/modules/${mod}/api/generated/${mod}.ts`)

    if (!existsSync(apiFile)) {
      skip(`跳过 ${mod.toUpperCase()} - 文件不存在`)
      continue
    }

    const content = readFileSync(apiFile, 'utf8')

    // 检查是否有 export const
    const exportMatches = content.match(/export const \w+/g)
    if (exportMatches && exportMatches.length > 0) {
      pass(`${mod.toUpperCase()} 导出了 ${exportMatches.length} 个函数`)
    } else {
      fail(`${mod.toUpperCase()} 没有找到导出的函数`)
    }
  }
}

// ========== 测试 5: 检查类型导入 ==========

function testTypeImports() {
  console.log('\n🔍 测试 5: 检查类型导入...')

  const modules = ['reader', 'bookstore', 'admin', 'writer', 'social', 'ai', 'finance', 'notification']

  for (const mod of modules) {
    const apiFile = resolve(root, `src/modules/${mod}/api/generated/${mod}.ts`)

    if (!existsSync(apiFile)) {
      skip(`跳过 ${mod.toUpperCase()} - 文件不存在`)
      continue
    }

    const content = readFileSync(apiFile, 'utf8')

    // 检查是否导入了类型
    if (content.includes('import type {')) {
      pass(`${mod.toUpperCase()} 包含类型导入`)
    } else {
      fail(`${mod.toUpperCase()} 缺少类型导入`)
    }
  }
}

// ========== 测试 6: 检查 mutator 集成 ==========

function testMutatorIntegration() {
  console.log('\n🔍 测试 6: 检查 mutator 集成...')

  const mutatorFile = resolve(root, 'src/core/config/orval-mutator.ts')

  if (!existsSync(mutatorFile)) {
    fail(`mutator 文件不存在: ${mutatorFile}`)
    return
  }

  const content = readFileSync(mutatorFile, 'utf8')

  if (content.includes('export const defaultMutator')) {
    pass(`mutator 导出 defaultMutator 函数`)
  } else {
    fail(`mutator 缺少 defaultMutator 导出`)
  }

  if (content.includes('httpService')) {
    pass(`mutator 集成了 httpService`)
  } else {
    fail(`mutator 未集成 httpService`)
  }
}

// ========== 测试 7: 检查 orval 配置 ==========

function testOrvalConfig() {
  console.log('\n🔍 测试 7: 检查 orval 配置...')

  const configFile = resolve(root, 'orval.config.ts')

  if (!existsSync(configFile)) {
    fail(`orval 配置文件不存在: ${configFile}`)
    return
  }

  const content = readFileSync(configFile, 'utf8')

  const modules = ['reader', 'bookstore', 'admin', 'writer', 'social', 'ai', 'finance', 'notification']

  for (const mod of modules) {
    if (content.includes(`${mod}:`)) {
      pass(`orval 配置包含 ${mod.toUpperCase()} 模块`)
    } else {
      fail(`orval 配置缺少 ${mod.toUpperCase()} 模块`)
    }
  }
}

// ========== 测试 8: 语法检查（尝试解析） ==========

function testSyntaxValidity() {
  console.log('\n🔍 测试 8: 语法有效性检查...')

  const modules = ['reader', 'bookstore', 'admin', 'writer', 'social', 'ai', 'finance', 'notification']

  for (const mod of modules) {
    const apiFile = resolve(root, `src/modules/${mod}/api/generated/${mod}.ts`)

    if (!existsSync(apiFile)) {
      skip(`跳过 ${mod.toUpperCase()} - 文件不存在`)
      continue
    }

    try {
      const content = readFileSync(apiFile, 'utf8')

      // 基本语法检查
      if (content.includes('import') && content.includes('export')) {
        pass(`${mod.toUpperCase()} 基本语法结构正常`)
      } else {
        fail(`${mod.toUpperCase()} 语法结构异常`)
      }

      // 不再检查 undefined/NaN，因为这些在代码中是正常的
    } catch (e) {
      fail(`${mod.toUpperCase()} 读取失败: ${e.message}`)
    }
  }
}

// ========== 主流程 ==========

function main() {
  console.log('╔════════════════════════════════════════════════════════════╗')
  console.log('║     API 函数可用性测试                                    ║')
  console.log('╚════════════════════════════════════════════════════════════╝')

  testGeneratedFilesExist()
  testGlobalSchemas()
  testGenerationHeaders()
  testExportedFunctions()
  testTypeImports()
  testMutatorIntegration()
  testOrvalConfig()
  testSyntaxValidity()

  console.log('\n' + '═'.repeat(60))
  console.log('📊 测试结果汇总:')
  console.log(`  ✅ 通过: ${results.passed.length}`)
  console.log(`  ❌ 失败: ${results.failed.length}`)
  console.log(`  ⏭️  跳过: ${results.skipped.length}`)
  console.log('═'.repeat(60))

  if (results.failed.length > 0) {
    console.error('\n❌ 部分测试失败，请检查上述错误信息')
    process.exit(1)
  } else {
    console.log('\n🎉 所有测试通过！API 函数可用性验证成功！')
    process.exit(0)
  }
}

main()
