#!/usr/bin/env node
/**
 * CI æ ¡éªŒè„šæœ¬ï¼šAPI ç”Ÿæˆè´¨é‡æ£€æŸ¥
 *
 * ç”¨é€”ï¼š
 * - é˜²æ­¢ Swagger è·¯å¾„æ ¼å¼é”™è¯¯
 * - ç¡®ä¿æ¨¡å—è¾“å‡ºéš”ç¦»
 * - å¼ºåˆ¶å…¨å±€ schemas å”¯ä¸€
 * - ç¦æ­¢æ‰‹å·¥ä¿®æ”¹ generated æ–‡ä»¶
 *
 * ä½¿ç”¨ï¼š
 *   node scripts/check-api-generation.mjs
 *
 * é€€å‡ºç ï¼š
 *   0 - æ‰€æœ‰æ£€æŸ¥é€šè¿‡
 *   1 - è‡³å°‘ä¸€é¡¹æ£€æŸ¥å¤±è´¥
 */

import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)
const root = path.resolve(__dirname, '..')

let exitCode = 0

function fail(msg) {
  console.error(`âŒ  ${msg}`)
  exitCode = 1
}

function ok(msg) {
  console.log(`âœ…  ${msg}`)
}

// ========== æ£€æŸ¥ 1ï¸âƒ£ï¼šSwagger è·¯å¾„ä¸å« Gin é£æ ¼çš„ /: ==========

function checkSwaggerNoColonParams() {
  console.log('\nğŸ” æ£€æŸ¥ 1ï¸âƒ£ï¼šSwagger è·¯å¾„ä¸å« /: å‚æ•°...')

  const swaggerPath = path.resolve(
    root,
    '../Qingyu_backend/docs/swagger.yaml'
  )

  if (!fs.existsSync(swaggerPath)) {
    fail(`Swagger æ–‡ä»¶ä¸å­˜åœ¨: ${swaggerPath}`)
    return
  }

  const content = fs.readFileSync(swaggerPath, 'utf8')
  const colonPaths = content.match(/\n\s*\/[^\s]*:/g)

  if (colonPaths) {
    fail(
      `å‘ç° Gin é£æ ¼è·¯å¾„å‚æ•° /: (åº”è¯¥æ˜¯ OpenAPI çš„ {}):\n` +
        colonPaths.map((s) => `   ${s.trim()}`).join('\n')
    )
  } else {
    ok('Swagger è·¯å¾„å‚æ•°æ ¼å¼æ­£ç¡®ï¼ˆæ—  /:ï¼‰ã€‚')
  }
}

// ========== æ£€æŸ¥ 2ï¸âƒ£ï¼šæ¨¡å—è¾“å‡ºéš”ç¦» ==========

function checkModuleOutputsIsolation() {
  console.log('\nğŸ” æ£€æŸ¥ 2ï¸âƒ£ï¼šæ¨¡å—è¾“å‡ºéš”ç¦»...')

  const modules = ['reader', 'bookstore', 'admin']
  const orvalConfig = path.resolve(root, 'orval.config.ts')

  if (!fs.existsSync(orvalConfig)) {
    fail(`Orval é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: ${orvalConfig}`)
    return
  }

  const configContent = fs.readFileSync(orvalConfig, 'utf8')

  // æ£€æŸ¥æ˜¯å¦é…ç½®äº† filters
  for (const mod of modules) {
    const hasFilter =
      configContent.includes(`${mod}:`) &&
      (configContent.includes(`paths: ['^/${mod}/']`) ||
        configContent.includes(`tags: ['${mod}']`))

    if (!hasFilter) {
      fail(`æ¨¡å— ${mod} æœªé…ç½® input.filtersï¼Œå¯èƒ½ç”Ÿæˆå…¨é‡æ¥å£`)
    } else {
      ok(`æ¨¡å— ${mod} å·²é…ç½®è·¯å¾„è¿‡æ»¤`)
    }
  }
}

// ========== æ£€æŸ¥ 3ï¸âƒ£ï¼šå…¨å±€ schemas å”¯ä¸€æ€§ ==========

function checkGlobalSchemasSingleton() {
  console.log('\nğŸ” æ£€æŸ¥ 3ï¸âƒ£ï¼šå…¨å±€ schemas å”¯ä¸€æ€§...')

  const globalSchema = path.resolve(root, 'src/api/generated/model.ts')

  // å¿…é¡»å­˜åœ¨å…¨å±€ schemas
  if (!fs.existsSync(globalSchema)) {
    fail(`å…¨å±€ schemas ç¼ºå¤±: ${globalSchema}`)
    return
  }

  ok(`å…¨å±€ schemas å­˜åœ¨: ${globalSchema}`)

  // æ‰«æ modules ä¸‹æ˜¯å¦è¿˜æœ‰ model.ts
  const modulesDir = path.resolve(root, 'src/modules')
  const offenders = []

  function walk(dir) {
    if (!fs.existsSync(dir)) return
    for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
      const full = path.join(dir, entry.name)
      if (entry.isDirectory()) walk(full)
      if (
        entry.isFile() &&
        entry.name === 'model.ts' &&
        full.includes(`${path.sep}api${path.sep}generated${path.sep}`)
      ) {
        offenders.push(full)
      }
    }
  }

  walk(modulesDir)

  if (offenders.length > 0) {
    fail(
      `å‘ç°é‡å¤çš„ model.tsï¼ˆåªæœ‰å…¨å±€ schemas æ˜¯å…è®¸çš„ï¼‰:\n` +
        offenders.map((f) => `   - ${f}`).join('\n')
    )
  } else {
    ok('å…¨å±€ schemas å”¯ä¸€æ€§æ£€æŸ¥é€šè¿‡ï¼ˆæ— æ¨¡å—çº§ model.tsï¼‰')
  }
}

// ========== æ£€æŸ¥ 4ï¸âƒ£ï¼šgenerated ç¦æ­¢æ‰‹æ”¹ ==========

function checkGeneratedFilesHeader() {
  console.log('\nğŸ” æ£€æŸ¥ 4ï¸âƒ£ï¼šgenerated æ–‡ä»¶ç¦æ­¢æ‰‹æ”¹...')

  const generatedRoots = [
    path.resolve(root, 'src/modules'),
    path.resolve(root, 'src/api/generated'),
  ]

  // åŒ¹é…ä»»ä¸€ç”Ÿæˆæ ‡è®°
  const headerRegex = /(Generated by orval|@generated|DO NOT EDIT)/i
  const offenders = []

  function walk(dir) {
    if (!fs.existsSync(dir)) return
    for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
      const full = path.join(dir, entry.name)
      if (entry.isDirectory()) walk(full)
      if (
        entry.isFile() &&
        entry.name.endsWith('.ts') &&
        full.includes(`${path.sep}generated${path.sep}`)
      ) {
        const content = fs.readFileSync(full, 'utf8').slice(0, 500)
        if (!headerRegex.test(content)) {
          offenders.push(full)
        }
      }
    }
  }

  generatedRoots.forEach(walk)

  if (offenders.length > 0) {
    fail(
      `ä»¥ä¸‹ generated æ–‡ä»¶ç¼ºå°‘ç”Ÿæˆæ ‡è®°ï¼ˆå¯èƒ½è¢«æ‰‹å·¥ä¿®æ”¹ï¼‰:\n` +
        `   å…è®¸çš„æ ‡è®°ï¼š@generated | Generated by orval | DO NOT EDIT\n` +
        offenders.map((f) => `   - ${f}`).join('\n')
    )
  } else {
    ok('æ‰€æœ‰ generated æ–‡ä»¶åŒ…å«æ­£ç¡®çš„ç”Ÿæˆæ ‡è®°')
  }
}

// ========== ä¸»æµç¨‹ ==========

function main() {
  console.log('ğŸ” è¿è¡Œ CI API ç”Ÿæˆæ ¡éªŒ...\n')

  checkSwaggerNoColonParams()
  checkModuleOutputsIsolation()
  checkGlobalSchemasSingleton()
  checkGeneratedFilesHeader()

  console.log('\n' + '='.repeat(60))

  if (exitCode === 1) {
    console.error('âŒ CI API æ ¡éªŒå¤±è´¥')
    console.error('\nğŸ’¡ ä¿®å¤å»ºè®®ï¼š')
    console.error('   1. æ£€æŸ¥åç«¯ Swagger æ³¨é‡Šä¸­çš„ @Router è·¯å¾„æ ¼å¼')
    console.error('   2. ç¡®ä¿ orval.config.ts ä¸­æ¯ä¸ªæ¨¡å—éƒ½æœ‰ filters')
    console.error('   3. åˆ é™¤æ¨¡å—çº§çš„ model.tsï¼Œåªä¿ç•™ src/api/generated/model.ts')
    console.error('   4. ä¸è¦ä¿®æ”¹ generated ç›®å½•ä¸‹çš„æ–‡ä»¶')
    process.exit(1)
  } else {
    console.log('âœ… æ‰€æœ‰ CI API æ ¡éªŒé€šè¿‡')
  }
}

main()
