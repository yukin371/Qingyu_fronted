<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤è¯è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #409eff;
            padding-bottom: 10px;
        }
        .key {
            color: #409eff;
            font-weight: bold;
        }
        .value {
            color: #333;
            word-break: break-all;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.danger {
            background: #f56c6c;
        }
        button.danger:hover {
            background: #f78989;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ è®¤è¯è°ƒè¯•å·¥å…·</h1>

    <div class="section">
        <h3>LocalStorage çŠ¶æ€</h3>
        <div id="localStorage-status"></div>
        <button onclick="clearAuth()">æ¸…é™¤è®¤è¯ä¿¡æ¯</button>
    </div>

    <div class="section">
        <h3>JWT Token è§£æ</h3>
        <div id="token-info"></div>
    </div>

    <div class="section">
        <h3>æµ‹è¯• API è¯·æ±‚</h3>
        <button onclick="testWriterAPI()">æµ‹è¯• /api/v1/writer/projects</button>
        <button onclick="testAuthAPI()">æµ‹è¯• /api/v1/shared/auth/roles</button>
        <div id="api-result"></div>
    </div>

    <script>
        // æ˜¾ç¤º LocalStorage çŠ¶æ€
        function showLocalStorageStatus() {
            const keys = ['qingyu_token', 'qingyu_refreshToken', 'qingyu_user', 'qingyu_roles'];
            let html = '<table style="width:100%">';
            html += '<tr><th style="text-align:left">Key</th><th style="text-align:left">Value</th></tr>';

            keys.forEach(key => {
                const value = localStorage.getItem(key);
                html += '<tr>';
                html += `<td><span class="key">${key}</span></td>`;
                if (value) {
                    if (key.includes('token')) {
                        html += `<td><span class="value">${value.substring(0, 50)}...</span></td>`;
                    } else {
                        html += `<td><span class="value">${value}</span></td>`;
                    }
                } else {
                    html += `<td><span class="value" style="color:#999;">(ç©º)</span></td>`;
                }
                html += '</tr>';
            });

            html += '</table>';
            document.getElementById('localStorage-status').innerHTML = html;
        }

        // è§£æ JWT Token
        function parseJWT(token) {
            if (!token) return null;

            try {
                const parts = token.split('.');
                if (parts.length !== 3) return null;

                const payload = parts[1];
                const decoded = atob(payload);
                return JSON.parse(decoded);
            } catch (e) {
                console.error('Token è§£æå¤±è´¥:', e);
                return null;
            }
        }

        // æ˜¾ç¤º Token ä¿¡æ¯
        function showTokenInfo() {
            const token = localStorage.getItem('qingyu_token');
            let html = '';

            if (!token) {
                html = '<p style="color:#f56c6c;">âŒ æœªæ‰¾åˆ° Token</p>';
            } else {
                const claims = parseJWT(token);
                if (!claims) {
                    html = '<p style="color:#f56c6c;">âŒ Token æ ¼å¼é”™è¯¯</p>';
                } else {
                    html = '<table style="width:100%">';
                    html += '<tr><th style="text-align:left">Claim</th><th style="text-align:left">Value</th></tr>';

                    Object.keys(claims).forEach(key => {
                        const value = JSON.stringify(claims[key]);
                        html += '<tr>';
                        html += `<td><span class="key">${key}</span></td>`;
                        html += `<td><span class="value">${value}</span></td>`;
                        html += '</tr>';
                    });

                    html += '</table>';

                    // æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
                    const now = Math.floor(Date.now() / 1000);
                    if (claims.exp && claims.exp < now) {
                        html += '<p style="color:#f56c6c;">âŒ Token å·²è¿‡æœŸ</p>';
                    } else if (claims.exp) {
                        const remaining = claims.exp - now;
                        const minutes = Math.floor(remaining / 60);
                        const seconds = remaining % 60;
                        html += `<p style="color:#67c23a;">âœ… Token æœ‰æ•ˆï¼Œå‰©ä½™æ—¶é—´: ${minutes}åˆ†${seconds}ç§’</p>`;
                    }
                }
            }

            document.getElementById('token-info').innerHTML = html;
        }

        // æ¸…é™¤è®¤è¯ä¿¡æ¯
        function clearAuth() {
            localStorage.removeItem('qingyu_token');
            localStorage.removeItem('qingyu_refreshToken');
            localStorage.removeItem('qingyu_user');
            localStorage.removeItem('qingyu_roles');
            showLocalStorageStatus();
            showTokenInfo();
        }

        // æµ‹è¯• API è¯·æ±‚
        async function testAPI(url) {
            const token = localStorage.getItem('qingyu_token');
            let html = `<h4>è¯·æ±‚: ${url}</h4>`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                html += `<p>çŠ¶æ€ç : <span class="${response.ok ? 'value' : 'value'}" style="color:${response.ok ? '#67c23a' : '#f56c6c'}">${response.status}</span></p>`;

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    const text = await response.text();
                    html += '<pre>' + text + '</pre>';
                }
            } catch (error) {
                html += `<p style="color:#f56c6c;">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            }

            document.getElementById('api-result').innerHTML = html;
        }

        function testWriterAPI() {
            testAPI('/api/v1/writer/projects');
        }

        function testAuthAPI() {
            testAPI('/api/v1/shared/auth/roles');
        }

        // åˆå§‹åŒ–
        showLocalStorageStatus();
        showTokenInfo();
    </script>
</body>
</html>
