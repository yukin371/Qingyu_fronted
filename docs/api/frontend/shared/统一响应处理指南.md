# ç»Ÿä¸€å“åº”å¤„ç†æŒ‡å—

> **æ–‡ä»¶ä½ç½®**: `api/v1/shared/response.go`
> **æ›´æ–°æ—¥æœŸ**: 2025-10-08
> **çŠ¶æ€**: âœ… å·²å®ç°

---

## ğŸ“‹ æ¦‚è¿°

ä¸ºäº†ç¡®ä¿æ•´ä¸ªé¡¹ç›®çš„APIå“åº”æ ¼å¼ç»Ÿä¸€ï¼Œæˆ‘ä»¬åœ¨ `api/v1/shared`åŒ…ä¸­å®šä¹‰äº†ä¸€å¥—æ ‡å‡†çš„å“åº”å¤„ç†å‡½æ•°ã€‚æ‰€æœ‰APIå±‚çš„ä»£ç éƒ½åº”è¯¥ä½¿ç”¨è¿™äº›å‡½æ•°æ¥è¿”å›å“åº”ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ `c.JSON()`ã€‚

---

## ğŸ¯ æ ¸å¿ƒå“åº”å‡½æ•°

### 1. Success - æˆåŠŸå“åº”

ç”¨äºæ‰€æœ‰APIæˆåŠŸæƒ…å†µã€‚

```go
func Success(c *gin.Context, statusCode int, message string, data interface{})
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
// è¿”å›å•ä¸ªå¯¹è±¡
shared.Success(c, http.StatusOK, "è·å–æˆåŠŸ", user)

// è¿”å›åˆ—è¡¨
shared.Success(c, http.StatusOK, "è·å–æˆåŠŸ", users)

// è¿”å›åˆ›å»ºç»“æœ
shared.Success(c, http.StatusCreated, "åˆ›å»ºæˆåŠŸ", newBook)

// è¿”å›ç©ºæ•°æ®
shared.Success(c, http.StatusOK, "ä¿å­˜æˆåŠŸ", nil)

// è¿”å›å¤æ‚æ•°æ®
shared.Success(c, http.StatusOK, "è·å–æˆåŠŸ", gin.H{
    "chapters": chapters,
    "total":    total,
    "page":     page,
})
```

**å“åº”æ ¼å¼**ï¼š

```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": { ... },
  "timestamp": 1696789200
}
```

---

### 2. Error - é”™è¯¯å“åº”

ç”¨äºæ‰€æœ‰APIé”™è¯¯æƒ…å†µã€‚

```go
func Error(c *gin.Context, statusCode int, message string, errorDetail string)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
// èµ„æºä¸å­˜åœ¨
shared.Error(c, http.StatusNotFound, "ç« èŠ‚ä¸å­˜åœ¨", err.Error())

// å†…éƒ¨é”™è¯¯
shared.Error(c, http.StatusInternalServerError, "è·å–é˜…è¯»è¿›åº¦å¤±è´¥", err.Error())

// ä¸šåŠ¡é€»è¾‘é”™è¯¯
shared.Error(c, http.StatusConflict, "ç”¨æˆ·åå·²å­˜åœ¨", "è¯¥ç”¨æˆ·åå·²è¢«æ³¨å†Œ")

// å‚æ•°é”™è¯¯
shared.Error(c, http.StatusBadRequest, "å‚æ•°é”™è¯¯", "ä¹¦ç±IDä¸èƒ½ä¸ºç©º")

// æƒé™ä¸è¶³
shared.Error(c, http.StatusForbidden, "è·å–ç« èŠ‚å†…å®¹å¤±è´¥", err.Error())
```

**å“åº”æ ¼å¼**ï¼š

```json
{
  "code": 404,
  "message": "ç« èŠ‚ä¸å­˜åœ¨",
  "error": "chapter not found in database",
  "timestamp": 1696789200
}
```

---

### 3. ValidationError - å‚æ•°éªŒè¯é”™è¯¯

ä¸“é—¨ç”¨äºå¤„ç†å‚æ•°éªŒè¯å¤±è´¥çš„æƒ…å†µã€‚

```go
func ValidationError(c *gin.Context, err error)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
var req SaveProgressRequest
if err := c.ShouldBindJSON(&req); err != nil {
    shared.ValidationError(c, err)
    return
}
```

**å“åº”æ ¼å¼**ï¼š

```json
{
  "code": 400,
  "message": "å‚æ•°éªŒè¯å¤±è´¥",
  "error": "Field validation for 'BookID' failed on the 'required' tag",
  "timestamp": 1696789200
}
```

---

## ğŸš€ ä¾¿æ·å“åº”å‡½æ•°

ä¸ºå¸¸è§çš„HTTPçŠ¶æ€ç æä¾›äº†ä¾¿æ·å‡½æ•°ï¼š

### 4. Unauthorized - æœªæˆæƒ (401)

```go
func Unauthorized(c *gin.Context, message string)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
userID, exists := c.Get("userId")
if !exists {
    shared.Unauthorized(c, "è¯·å…ˆç™»å½•")
    return
}
```

**å“åº”æ ¼å¼**ï¼š

```json
{
  "code": 401,
  "message": "è¯·å…ˆç™»å½•",
  "error": "è¯·å…ˆç™»å½•æˆ–æä¾›æœ‰æ•ˆçš„è®¿é—®å‡­è¯",
  "timestamp": 1696789200
}
```

---

### 5. Forbidden - ç¦æ­¢è®¿é—® (403)

```go
func Forbidden(c *gin.Context, message string)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
if !hasPermission {
    shared.Forbidden(c, "æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤ç« èŠ‚")
    return
}
```

---

### 6. NotFound - èµ„æºä¸å­˜åœ¨ (404)

```go
func NotFound(c *gin.Context, message string)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
chapter, err := api.readerService.GetChapterByID(c.Request.Context(), chapterID)
if err != nil {
    shared.NotFound(c, "ç« èŠ‚ä¸å­˜åœ¨")
    return
}
```

---

### 7. BadRequest - é”™è¯¯è¯·æ±‚ (400)

```go
func BadRequest(c *gin.Context, message string, errorDetail string)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
bookID := c.Query("bookId")
if bookID == "" {
    shared.BadRequest(c, "å‚æ•°é”™è¯¯", "ä¹¦ç±IDä¸èƒ½ä¸ºç©º")
    return
}
```

---

### 8. InternalError - å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ (500)

```go
func InternalError(c *gin.Context, message string, err error)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
progress, err := api.readerService.GetReadingProgress(ctx, userID, bookID)
if err != nil {
    shared.InternalError(c, "è·å–é˜…è¯»è¿›åº¦å¤±è´¥", err)
    return
}
```

---

## ğŸ“¦ åˆ†é¡µå“åº”

### 9. Paginated - åˆ†é¡µå“åº”

```go
func Paginated(c *gin.Context, data interface{}, total int64, page, pageSize int, message string)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
chapters, total, err := api.readerService.GetBookChaptersWithPagination(ctx, bookID, page, size)
if err != nil {
    shared.Error(c, http.StatusInternalServerError, "è·å–ç« èŠ‚åˆ—è¡¨å¤±è´¥", err.Error())
    return
}

shared.Paginated(c, chapters, total, page, size, "è·å–æˆåŠŸ")
```

**å“åº”æ ¼å¼**ï¼š

```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": [...],
  "timestamp": 1696789200,
  "pagination": {
    "total": 100,
    "page": 1,
    "page_size": 20,
    "total_pages": 5,
    "has_next": true,
    "has_previous": false
  }
}
```

---

## ğŸ”‘ å¸¦RequestIDçš„å“åº”

ç”¨äºéœ€è¦è¿½è¸ªè¯·æ±‚çš„åœºæ™¯ï¼š

### 10. SuccessWithRequestID

```go
func SuccessWithRequestID(c *gin.Context, statusCode int, message string, data interface{}, requestID string)
```

### 11. ErrorWithRequestID

```go
func ErrorWithRequestID(c *gin.Context, statusCode int, message string, errorDetail string, requestID string)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
requestID := c.GetString("request_id") // ä»ä¸­é—´ä»¶è·å–
shared.SuccessWithRequestID(c, http.StatusOK, "è·å–æˆåŠŸ", data, requestID)
```

---

## ğŸ“š å®é™…åº”ç”¨ç¤ºä¾‹

### é˜…è¯»å™¨APIå®Œæ•´ç¤ºä¾‹

```go
package reader

import (
    "net/http"
    "github.com/gin-gonic/gin"
    "Qingyu_backend/api/v1/shared"
    "Qingyu_backend/service/reading"
)

type SettingAPI struct {
    readerService *reading.ReaderService
}

// GetReadingSettings è·å–é˜…è¯»è®¾ç½®
func (api *SettingAPI) GetReadingSettings(c *gin.Context) {
    // 1. éªŒè¯ç”¨æˆ·è®¤è¯
    userID, exists := c.Get("userId")
    if !exists {
        shared.Unauthorized(c, "è¯·å…ˆç™»å½•")
        return
    }

    // 2. è°ƒç”¨Serviceå±‚
    settings, err := api.readerService.GetReadingSettings(c.Request.Context(), userID.(string))
    if err != nil {
        shared.InternalError(c, "è·å–é˜…è¯»è®¾ç½®å¤±è´¥", err)
        return
    }

    // 3. è¿”å›æˆåŠŸå“åº”
    shared.Success(c, http.StatusOK, "è·å–æˆåŠŸ", settings)
}

// SaveReadingSettings ä¿å­˜é˜…è¯»è®¾ç½®
func (api *SettingAPI) SaveReadingSettings(c *gin.Context) {
    // 1. éªŒè¯ç”¨æˆ·è®¤è¯
    userID, exists := c.Get("userId")
    if !exists {
        shared.Unauthorized(c, "è¯·å…ˆç™»å½•")
        return
    }

    // 2. å‚æ•°ç»‘å®šå’ŒéªŒè¯
    var settings reader.ReadingSettings
    if err := c.ShouldBindJSON(&settings); err != nil {
        shared.ValidationError(c, err)
        return
    }

    // 3. è®¾ç½®ç”¨æˆ·ID
    settings.UserID = userID.(string)

    // 4. è°ƒç”¨Serviceå±‚
    err := api.readerService.SaveReadingSettings(c.Request.Context(), &settings)
    if err != nil {
        shared.InternalError(c, "ä¿å­˜é˜…è¯»è®¾ç½®å¤±è´¥", err)
        return
    }

    // 5. è¿”å›æˆåŠŸå“åº”
    shared.Success(c, http.StatusOK, "ä¿å­˜æˆåŠŸ", nil)
}

// GetBookChapters è·å–ä¹¦ç±ç« èŠ‚åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
func (api *ChaptersAPI) GetBookChapters(c *gin.Context) {
    // 1. å‚æ•°éªŒè¯
    bookID := c.Query("bookId")
    if bookID == "" {
        shared.BadRequest(c, "å‚æ•°é”™è¯¯", "ä¹¦ç±IDä¸èƒ½ä¸ºç©º")
        return
    }

    page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
    size, _ := strconv.Atoi(c.DefaultQuery("size", "20"))

    // 2. è°ƒç”¨Serviceå±‚
    chapters, total, err := api.readerService.GetBookChaptersWithPagination(
        c.Request.Context(), bookID, page, size)
    if err != nil {
        shared.InternalError(c, "è·å–ç« èŠ‚åˆ—è¡¨å¤±è´¥", err)
        return
    }

    // 3. è¿”å›åˆ†é¡µå“åº”
    shared.Paginated(c, chapters, total, page, size, "è·å–æˆåŠŸ")
}
```

---

## âœ… æœ€ä½³å®è·µ

### 1. å§‹ç»ˆä½¿ç”¨ç»Ÿä¸€å“åº”å‡½æ•°

âŒ **é”™è¯¯åšæ³•**ï¼š

```go
c.JSON(http.StatusOK, gin.H{
    "code": 200,
    "message": "success",
    "data": user,
})
```

âœ… **æ­£ç¡®åšæ³•**ï¼š

```go
shared.Success(c, http.StatusOK, "è·å–æˆåŠŸ", user)
```

---

### 2. é€‰æ‹©åˆé€‚çš„å“åº”å‡½æ•°

æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©æœ€åˆé€‚çš„å‡½æ•°ï¼š

```go
// é€šç”¨é”™è¯¯ - ä½¿ç”¨Error
shared.Error(c, http.StatusInternalServerError, "æ“ä½œå¤±è´¥", err.Error())

// æœªæˆæƒ - ä½¿ç”¨Unauthorized
shared.Unauthorized(c, "è¯·å…ˆç™»å½•")

// èµ„æºä¸å­˜åœ¨ - ä½¿ç”¨NotFound
shared.NotFound(c, "ç”¨æˆ·ä¸å­˜åœ¨")

// å‚æ•°é”™è¯¯ - ä½¿ç”¨BadRequest
shared.BadRequest(c, "å‚æ•°é”™è¯¯", "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º")

// å‚æ•°éªŒè¯ - ä½¿ç”¨ValidationError
shared.ValidationError(c, err)
```

---

### 3. æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯

âŒ **é”™è¯¯åšæ³•**ï¼š

```go
shared.Error(c, http.StatusInternalServerError, "é”™è¯¯", "å¤±è´¥")
```

âœ… **æ­£ç¡®åšæ³•**ï¼š

```go
shared.Error(c, http.StatusInternalServerError, "è·å–é˜…è¯»è¿›åº¦å¤±è´¥", err.Error())
```

---

### 4. ä½¿ç”¨åˆé€‚çš„HTTPçŠ¶æ€ç 

| åœºæ™¯       | çŠ¶æ€ç  | å“åº”å‡½æ•°                                        |
| ---------- | ------ | ----------------------------------------------- |
| æˆåŠŸè·å–   | 200    | `Success(c, http.StatusOK, ...)`              |
| æˆåŠŸåˆ›å»º   | 201    | `Success(c, http.StatusCreated, ...)`         |
| å‚æ•°é”™è¯¯   | 400    | `BadRequest(...)` æˆ– `ValidationError(...)` |
| æœªæˆæƒ     | 401    | `Unauthorized(...)`                           |
| ç¦æ­¢è®¿é—®   | 403    | `Forbidden(...)`                              |
| èµ„æºä¸å­˜åœ¨ | 404    | `NotFound(...)`                               |
| å†…éƒ¨é”™è¯¯   | 500    | `InternalError(...)`                          |

---

### 5. åˆ†é¡µå“åº”ç»Ÿä¸€æ ¼å¼

æ‰€æœ‰åˆ†é¡µAPIéƒ½åº”è¯¥ä½¿ç”¨ `Paginated`å‡½æ•°ï¼š

```go
shared.Paginated(c, items, total, page, pageSize, "è·å–æˆåŠŸ")
```

è¿™æ ·å¯ä»¥ç¡®ä¿å‰ç«¯è·å¾—ç»Ÿä¸€çš„åˆ†é¡µä¿¡æ¯æ ¼å¼ã€‚

---

## ğŸ“Š å“åº”æ ¼å¼è§„èŒƒ

### æˆåŠŸå“åº”ç»“æ„

```typescript
interface SuccessResponse {
  code: number;           // HTTPçŠ¶æ€ç 
  message: string;        // æˆåŠŸæ¶ˆæ¯
  data?: any;            // æ•°æ®å†…å®¹ï¼ˆå¯é€‰ï¼‰
  timestamp: number;      // å“åº”æ—¶é—´æˆ³
  request_id?: string;   // è¯·æ±‚IDï¼ˆå¯é€‰ï¼‰
}
```

### é”™è¯¯å“åº”ç»“æ„

```typescript
interface ErrorResponse {
  code: number;           // HTTPçŠ¶æ€ç 
  message: string;        // é”™è¯¯æ¶ˆæ¯
  error?: string;        // è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
  timestamp: number;      // å“åº”æ—¶é—´æˆ³
  request_id?: string;   // è¯·æ±‚IDï¼ˆå¯é€‰ï¼‰
}
```

### åˆ†é¡µå“åº”ç»“æ„

```typescript
interface PaginatedResponse {
  code: number;
  message: string;
  data?: any[];
  timestamp: number;
  request_id?: string;
  pagination: {
    total: number;        // æ€»è®°å½•æ•°
    page: number;         // å½“å‰é¡µç 
    page_size: number;    // æ¯é¡µå¤§å°
    total_pages: number;  // æ€»é¡µæ•°
    has_next: boolean;    // æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
    has_previous: boolean; // æ˜¯å¦æœ‰ä¸Šä¸€é¡µ
  };
}
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. ä½¿ç”¨RequestIDè¿½è¸ªè¯·æ±‚

```go
// åœ¨ä¸­é—´ä»¶ä¸­è®¾ç½®RequestID
func RequestIDMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        requestID := uuid.New().String()
        c.Set("request_id", requestID)
        c.Next()
    }
}

// åœ¨APIä¸­ä½¿ç”¨
requestID := c.GetString("request_id")
shared.SuccessWithRequestID(c, http.StatusOK, "è·å–æˆåŠŸ", data, requestID)
```

### 2. æ—¥å¿—è®°å½•

```go
log.WithFields(logrus.Fields{
    "request_id": requestID,
    "user_id":    userID,
    "error":      err.Error(),
}).Error("è·å–é˜…è¯»è¿›åº¦å¤±è´¥")

shared.ErrorWithRequestID(c, http.StatusInternalServerError, 
    "è·å–é˜…è¯»è¿›åº¦å¤±è´¥", err.Error(), requestID)
```

---

## ğŸ“ è¿ç§»æŒ‡å—

å¦‚æœä½ æœ‰æ—§ä»£ç ä½¿ç”¨äº†ç›´æ¥çš„ `c.JSON()`è°ƒç”¨ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿ç§»ï¼š

### æ­¥éª¤1: è¯†åˆ«å“åº”ç±»å‹

```go
// æ—§ä»£ç 
c.JSON(http.StatusOK, gin.H{"code": 200, "data": user})
```

### æ­¥éª¤2: é€‰æ‹©åˆé€‚çš„å“åº”å‡½æ•°

```go
// æ–°ä»£ç 
shared.Success(c, http.StatusOK, "è·å–æˆåŠŸ", user)
```

### æ­¥éª¤3: ç»Ÿä¸€é”™è¯¯å¤„ç†

```go
// æ—§ä»£ç 
if err != nil {
    c.JSON(http.StatusInternalServerError, gin.H{
        "code": 500,
        "error": err.Error(),
    })
    return
}

// æ–°ä»£ç 
if err != nil {
    shared.InternalError(c, "æ“ä½œå¤±è´¥", err)
    return
}
```

---

## ğŸ¯ æ£€æŸ¥æ¸…å•

åœ¨æäº¤ä»£ç å‰ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] æ‰€æœ‰APIéƒ½ä½¿ç”¨äº† `shared`åŒ…çš„å“åº”å‡½æ•°
- [ ] æ²¡æœ‰ç›´æ¥ä½¿ç”¨ `c.JSON()`
- [ ] é”™è¯¯æ¶ˆæ¯æ¸…æ™°æ˜ç¡®
- [ ] ä½¿ç”¨äº†æ­£ç¡®çš„HTTPçŠ¶æ€ç 
- [ ] åˆ†é¡µAPIä½¿ç”¨äº† `Paginated`å‡½æ•°
- [ ] å“åº”æ ¼å¼ç¬¦åˆè§„èŒƒ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [APIè®¾è®¡è§„èŒƒ](../APIè®¾è®¡è§„èŒƒ.md)
- [é”™è¯¯å¤„ç†è§„èŒƒ](../../architecture/é”™è¯¯å¤„ç†è§„èŒƒ.md)
- [é˜…è¯»å™¨APIæ–‡æ¡£](../é˜…è¯»å™¨APIæ–‡æ¡£.md)

---

## âœ¨ æ€»ç»“

ç»Ÿä¸€çš„å“åº”å¤„ç†å‡½æ•°å¸¦æ¥çš„å¥½å¤„ï¼š

1. **ä¸€è‡´æ€§** - æ‰€æœ‰APIè¿”å›ç»Ÿä¸€æ ¼å¼çš„å“åº”
2. **å¯ç»´æŠ¤æ€§** - é›†ä¸­ç®¡ç†å“åº”æ ¼å¼ï¼Œä¾¿äºä¿®æ”¹
3. **å¯è¯»æ€§** - ä»£ç æ›´ç®€æ´æ¸…æ™°
4. **å¯æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ–°åŠŸèƒ½ï¼ˆå¦‚RequestIDã€æ—¥å¿—ç­‰ï¼‰
5. **å‰ç«¯å‹å¥½** - ç»Ÿä¸€çš„æ•°æ®æ ¼å¼ä¾¿äºå‰ç«¯å¤„ç†

**è¯·åœ¨æ‰€æœ‰æ–°APIä¸­ä½¿ç”¨è¿™äº›ç»Ÿä¸€çš„å“åº”å‡½æ•°ï¼** âœ…

---

**æœ€åæ›´æ–°**: 2025-10-08
**ç‰ˆæœ¬**: v1.0
