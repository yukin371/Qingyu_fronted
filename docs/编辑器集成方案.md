# 编辑器集成方案 - EditorView

**当前状态**: EditorView功能完备但未与project store集成  
**集成优先级**: P0（核心功能）

---

## 当前状况分析

### ✅ 已有功能（非常完善）

**EditorView.vue** (1330行) 包含：

1. **编辑器核心功能**
   - 文本编辑器（支持Markdown和纯文本模式）
   - Markdown实时预览
   - 双栏滚动同步
   - 专注模式

2. **AI辅助功能** ⭐
   - AI续写
   - AI润色
   - AI扩写
   - AI右键菜单
   - AI侧边栏

3. **自动保存机制**
   - `AutoSaveManager` 工具类
   - 定时自动保存
   - 保存状态显示

4. **导出功能**
   - 导出为TXT
   - 导出为Markdown
   - 导出为HTML

5. **章节管理**
   - ProjectSidebar组件（章节树）
   - 新建/编辑/删除章节
   - 章节切换

6. **扩展功能**
   - 大纲视图(OutlineView)
   - 角色图谱(CharacterGraphView)
   - 设定百科(EncyclopediaView)
   - 时间线工具(TimelineBar)
   - 字数统计
   - 快捷键支持

### ⚠️ 待集成问题

**当前使用模拟数据**:
```typescript
// line 293-299
const projects = ref([
  {
    id: '1',
    title: '我的第一本小说',
    status: 'published' as const,
    wordCount: 125000,
    // ... 模拟数据
  }
])
```

**使用旧的writerStore**:
```typescript
// line 261
import { useWriterStore } from '../stores/writerStore'
// line 273
const writerStore = useWriterStore()
```

**需要集成project store的功能**:
- [ ] 文档加载
- [ ] 文档保存
- [ ] 自动保存
- [ ] 文档切换
- [ ] 保存状态同步

---

## 集成方案

### 方案 A: 完全重构集成（推荐）⭐

**优点**:
- 使用真实API数据
- 与项目工作区统一
- 状态管理规范
- 代码可维护性高

**缺点**:
- 需要较多修改工作（约2-3小时）

**实施步骤**:

1. **引入project store**
```typescript
import { useProjectStore } from '@/stores/project'
import { useWriterStore } from '@/stores/writer'

const projectStore = useProjectStore()
const writerStore = useWriterStore()
```

2. **替换数据源**
```typescript
// 替换模拟数据
const currentProject = computed(() => writerStore.currentProject)
const currentDocument = computed(() => projectStore.currentDocument)
const fileContent = computed({
  get: () => projectStore.editorContent,
  set: (value) => projectStore.updateEditorContent(value)
})
const chapters = computed(() => projectStore.documentList)
```

3. **集成保存功能**
```typescript
// 手动保存
const handleSaveManually = async () => {
  if (!currentDocument.value) return
  
  isSaving.value = true
  try {
    await projectStore.saveDocumentContent(
      currentDocument.value.documentId,
      fileContent.value
    )
  } catch (error: any) {
    ElMessage.error('保存失败：' + (error.message || '未知错误'))
  } finally {
    isSaving.value = false
  }
}

// 自动保存
const autoSaveTimer = setInterval(() => {
  if (projectStore.hasUnsavedChanges) {
    handleSaveManually()
  }
}, 30000)
```

4. **集成文档加载**
```typescript
onMounted(async () => {
  const documentId = route.params.documentId as string
  if (documentId) {
    await projectStore.loadDocument(documentId)
  }
})
```

5. **集成章节切换**
```typescript
const handleChapterChange = async (documentId: string) => {
  // 保存当前文档
  if (projectStore.hasUnsavedChanges) {
    await handleSaveManually()
  }
  
  // 加载新文档
  await projectStore.loadDocument(documentId)
}
```

### 方案 B: 保持现状，仅修复API（不推荐）

**优点**:
- 修改工作量小
- 风险低

**缺点**:
- 不符合架构规范
- 状态不统一
- 后期维护困难

---

## 详细实施计划

### 阶段1: 基础集成（1-2小时）

**Step 1.1: 替换数据源**
```typescript
// 修改文件顶部导入
import { useProjectStore } from '@/stores/project'
const projectStore = useProjectStore()

// 修改数据源
const currentDocument = computed(() => projectStore.currentDocument)
const documentTitle = computed({
  get: () => currentDocument.value?.title || '',
  set: (value) => {
    if (currentDocument.value) {
      currentDocument.value.title = value
    }
  }
})
const fileContent = computed({
  get: () => projectStore.editorContent,
  set: (value) => projectStore.updateEditorContent(value)
})
```

**Step 1.2: 集成保存功能**
```typescript
// 替换保存逻辑
const handleSaveManually = async () => {
  if (!currentDocument.value) {
    ElMessage.warning('请先打开文档')
    return
  }

  try {
    await projectStore.saveDocumentContent(
      currentDocument.value.documentId,
      fileContent.value
    )
    lastSaveTime.value = new Date()
  } catch (error: any) {
    ElMessage.error('保存失败：' + (error.message || '未知错误'))
  }
}
```

**Step 1.3: 集成自动保存**
```typescript
// 使用project store的自动保存
const setupAutoSave = () => {
  autoSaveTimer = setInterval(() => {
    if (projectStore.hasUnsavedChanges && currentDocument.value) {
      projectStore.autoSave(
        currentDocument.value.documentId,
        fileContent.value,
        currentDocument.value.version || 0
      )
    }
  }, 30000)
}
```

### 阶段2: 章节管理集成（30分钟）

**Step 2.1: 集成章节列表**
```typescript
const chapters = computed(() => projectStore.documentList)
const currentChapterId = computed(() => projectStore.currentDocumentId)
```

**Step 2.2: 集成章节切换**
```typescript
const handleChapterChange = async (documentId: string) => {
  // 保存当前文档
  if (projectStore.hasUnsavedChanges) {
    await handleSaveManually()
  }
  
  // 加载新文档
  try {
    await projectStore.loadDocument(documentId)
  } catch (error: any) {
    ElMessage.error('加载文档失败：' + (error.message || '未知错误'))
  }
}
```

**Step 2.3: 集成新建章节**
```typescript
const handleAddChapter = async () => {
  if (!currentProject.value) return
  
  try {
    const doc = await projectStore.createNewDocument(
      currentProject.value.projectId,
      {
        title: newChapterForm.title,
        chapterNum: newChapterForm.chapterNum
      }
    )
    
    if (doc) {
      showNewChapterDialog.value = false
      await handleChapterChange(doc.documentId)
    }
  } catch (error: any) {
    ElMessage.error('创建章节失败：' + (error.message || '未知错误'))
  }
}
```

### 阶段3: 路由和生命周期集成（30分钟）

**Step 3.1: 修改路由参数**
```typescript
// 从路由参数加载文档
onMounted(async () => {
  const documentId = route.params.documentId as string
  const projectId = route.params.projectId as string
  
  if (projectId) {
    projectStore.setCurrentProject(projectId)
    await writerStore.fetchProjectById(projectId)
    await projectStore.fetchDocuments(projectId)
  }
  
  if (documentId) {
    await projectStore.loadDocument(documentId)
  }
  
  setupAutoSave()
  // ... 其他初始化
})
```

**Step 3.2: 修改离开前保存**
```typescript
onBeforeUnmount(() => {
  // 清除自动保存
  if (autoSaveTimer) {
    clearInterval(autoSaveTimer)
  }
  
  // 保存当前文档
  if (projectStore.hasUnsavedChanges) {
    handleSaveManually()
  }
})
```

**Step 3.3: 监听路由变化**
```typescript
import { watch } from 'vue'

watch(() => route.params.documentId, async (newId) => {
  if (newId && typeof newId === 'string') {
    await handleChapterChange(newId)
  }
})
```

### 阶段4: AI功能集成（已完成）

**当前AI功能已经在writerStore中**:
- ✅ AI续写
- ✅ AI润色
- ✅ AI扩写

**保持现状即可**，AI功能已经很完善。

---

## 修改文件清单

### 需要修改的文件
1. **EditorView.vue** - 核心编辑器页面（主要修改）
2. **ProjectSidebar.vue** - 项目侧边栏（可能需要小修改）

### 可能需要修改的组件
1. **EditorToolbar.vue** - 编辑器工具栏（可能不需要修改）
2. **AutoSaveManager** - 自动保存工具（可能需要调整API）

### 不需要修改的组件
1. **AIAssistantSidebar.vue** - AI助手（已集成writerStore）
2. **AIContextMenu.vue** - AI右键菜单（已集成writerStore）
3. **TimelineBar.vue** - 时间线
4. **OutlineView.vue** - 大纲视图
5. **CharacterGraphView.vue** - 角色图谱
6. **EncyclopediaView.vue** - 设定百科

---

## API对接清单

### 已有API（project store已支持）
- ✅ GET `/api/v1/documents/:id` - 获取文档详情
- ✅ GET `/api/v1/documents/:id/content` - 获取文档内容
- ✅ PUT `/api/v1/documents/:id/content` - 保存文档内容
- ✅ POST `/api/v1/documents/:id/autosave` - 自动保存
- ✅ POST `/api/v1/projects/:projectId/documents` - 创建文档
- ✅ PUT `/api/v1/documents/:id` - 更新文档
- ✅ DELETE `/api/v1/documents/:id` - 删除文档

### AI相关API（待确认后端是否实现）
- ⏳ POST `/api/v1/ai/continue` - AI续写
- ⏳ POST `/api/v1/ai/polish` - AI润色
- ⏳ POST `/api/v1/ai/expand` - AI扩写
- ⏳ POST `/api/v1/ai/rewrite` - AI重写
- ⏳ POST `/api/v1/ai/summarize` - AI总结

### 版本历史API（待实现）
- ⏳ GET `/api/v1/documents/:id/versions` - 获取版本列表
- ⏳ POST `/api/v1/documents/:id/versions/restore` - 恢复版本

---

## 测试计划

### 功能测试清单
1. [ ] 文档加载 - 打开编辑器加载文档内容
2. [ ] 手动保存 - 点击保存按钮正常保存
3. [ ] 自动保存 - 30秒自动保存工作正常
4. [ ] 文档切换 - 切换章节时保存并加载新文档
5. [ ] 新建章节 - 创建新章节并自动打开
6. [ ] 编辑器状态 - 保存状态显示正确
7. [ ] 字数统计 - 字数实时更新
8. [ ] Markdown预览 - 预览同步显示
9. [ ] 专注模式 - 专注模式正常切换
10. [ ] 导出功能 - TXT/MD/HTML导出正常

### 集成测试场景
1. **场景1: 从项目工作区打开编辑器**
   - 在ProjectWorkspace中选择文档
   - 点击"在编辑器中打开"
   - 验证编辑器加载正确的文档

2. **场景2: 编辑并自动保存**
   - 打开文档编辑
   - 等待30秒
   - 验证自动保存成功
   - 刷新页面，验证内容已保存

3. **场景3: 切换章节**
   - 打开文档A
   - 编辑内容但不保存
   - 切换到文档B
   - 验证提示保存
   - 验证文档A内容已保存

---

## 预计工作时间

| 阶段 | 内容 | 预计时间 |
|------|------|---------|
| 阶段1 | 基础集成 | 1-2小时 |
| 阶段2 | 章节管理 | 30分钟 |
| 阶段3 | 路由集成 | 30分钟 |
| 测试 | 功能测试 | 1小时 |
| **总计** | | **3-4小时** |

---

## 风险提示

1. **EditorView代码量大**（1330行）- 修改需谨慎
2. **AI功能API可能未实现** - 需要确认后端支持
3. **AutoSaveManager可能需要调整** - 需要适配新的API
4. **组件依赖复杂** - 修改可能影响其他组件

---

## 建议

1. ✅ **先完成基础集成**（文档加载、保存、自动保存）
2. ✅ **然后完善章节管理**（新建、切换、删除）
3. ⏳ **最后优化AI功能**（如果后端API未实现，可以先模拟）
4. ⏳ **版本历史功能可以延后**（不是P0功能）

---

**下一步行动**:
1. 开始阶段1的基础集成工作
2. 集成完成后立即进行功能测试
3. 确保保存、自动保存、加载功能正常

**预计完成时间**: 3-4小时  
**优先级**: P0（最高）  
**状态**: 待开始

---

**创建时间**: 2025-10-29  
**更新时间**: 2025-10-29

