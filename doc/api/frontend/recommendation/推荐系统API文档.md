# æ¨èç³»ç»Ÿ API æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0
> **æ›´æ–°æ—¶é—´**: 2025-10-10
> **åŸºç¡€è·¯å¾„**: `/api/v1/recommendation`
> **è®¤è¯æ–¹å¼**: Bearer Token (JWT)

---

## ğŸ“‹ API æ¥å£æ¦‚è§ˆ

### æ¥å£åˆ—è¡¨

| æ¥å£åç§°       | æ–¹æ³• | è·¯å¾„              | è®¤è¯    | è¯´æ˜                           |
| -------------- | ---- | ----------------- | ------- | ------------------------------ |
| è·å–ä¸ªæ€§åŒ–æ¨è | GET  | `/personalized` | âœ… éœ€è¦ | åŸºäºç”¨æˆ·ç”»åƒçš„ä¸ªæ€§åŒ–æ¨è       |
| è·å–ç›¸ä¼¼ç‰©å“   | GET  | `/similar`      | âŒ å…¬å¼€ | åŸºäºç‰©å“çš„ååŒè¿‡æ»¤æ¨è         |
| è®°å½•ç”¨æˆ·è¡Œä¸º   | POST | `/behavior`     | âœ… éœ€è¦ | è®°å½•ç”¨æˆ·æµè§ˆã€ç‚¹å‡»ã€æ”¶è—ç­‰è¡Œä¸º |

---

## ğŸ¯ API è¯¦ç»†è¯´æ˜

### 1. è·å–ä¸ªæ€§åŒ–æ¨è

**æ¥å£æè¿°**: åŸºäºç”¨æˆ·å†å²è¡Œä¸ºå’Œåå¥½ï¼Œè¿”å›ä¸ªæ€§åŒ–æ¨èçš„ä¹¦ç±åˆ—è¡¨ã€‚

#### è¯·æ±‚å‚æ•°

```http
GET /api/v1/recommendation/personalized?limit=10
Authorization: Bearer {token}
```

**Query å‚æ•°**

| å‚æ•°å | ç±»å‹    | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜                |
| ------ | ------- | ---- | ------ | ------------------- |
| limit  | integer | å¦   | 10     | æ¨èæ•°é‡ï¼ŒèŒƒå›´ 1-50 |

#### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº” (200)**

```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "recommendations": [
      "673c1a2f9d5f8e4b3c8a1234",
      "673c1a2f9d5f8e4b3c8a5678"
    ],
    "count": 2,
    "source": "user_profile"
  }
}
```

**æ•°æ®è¯´æ˜**

- `recommendations`: ä¹¦ç±IDåˆ—è¡¨ï¼ˆæ¨èæŒ‰ç›¸å…³åº¦æ’åºï¼‰
- `count`: æ¨èæ•°é‡
- `source`: æ¨èæ¥æº
  - `user_profile`: åŸºäºç”¨æˆ·ç”»åƒ
  - `hot_books`: çƒ­é—¨ä¹¦ç±ï¼ˆå†·å¯åŠ¨ï¼‰

**é”™è¯¯å“åº” (401)**

```json
{
  "code": 401,
  "message": "æœªæˆæƒï¼Œè¯·å…ˆç™»å½•"
}
```

---

### 2. è·å–ç›¸ä¼¼ç‰©å“

**æ¥å£æè¿°**: åŸºäºç‰©å“ç‰¹å¾ï¼Œè¿”å›ä¸æŒ‡å®šä¹¦ç±ç›¸ä¼¼çš„ä¹¦ç±åˆ—è¡¨ï¼ˆå…¬å¼€æ¥å£ï¼Œæ— éœ€è®¤è¯ï¼‰ã€‚

#### è¯·æ±‚å‚æ•°

```http
GET /api/v1/recommendation/similar?itemId=673c1a2f9d5f8e4b3c8a1234&limit=10
```

**Query å‚æ•°**

| å‚æ•°å | ç±»å‹    | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜                |
| ------ | ------- | ---- | ------ | ------------------- |
| itemId | string  | æ˜¯   | -      | ä¹¦ç±ID              |
| limit  | integer | å¦   | 10     | æ¨èæ•°é‡ï¼ŒèŒƒå›´ 1-50 |

#### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº” (200)**

```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "similar_items": [
      "673c1a2f9d5f8e4b3c8a5678",
      "673c1a2f9d5f8e4b3c8a9abc"
    ],
    "count": 2,
    "base_item": "673c1a2f9d5f8e4b3c8a1234"
  }
}
```

**æ•°æ®è¯´æ˜**

- `similar_items`: ç›¸ä¼¼ä¹¦ç±IDåˆ—è¡¨ï¼ˆæŒ‰ç›¸ä¼¼åº¦æ’åºï¼‰
- `count`: æ¨èæ•°é‡
- `base_item`: åŸºå‡†ä¹¦ç±ID

**é”™è¯¯å“åº” (400)**

```json
{
  "code": 400,
  "message": "ç¼ºå°‘å¿…å¡«å‚æ•°: itemId"
}
```

**é”™è¯¯å“åº” (404)**

```json
{
  "code": 404,
  "message": "ä¹¦ç±ä¸å­˜åœ¨"
}
```

---

### 3. è®°å½•ç”¨æˆ·è¡Œä¸º

**æ¥å£æè¿°**: è®°å½•ç”¨æˆ·çš„æµè§ˆã€ç‚¹å‡»ã€æ”¶è—ã€é˜…è¯»ç­‰è¡Œä¸ºï¼Œç”¨äºæ›´æ–°ç”¨æˆ·ç”»åƒå’Œæ”¹è¿›æ¨èæ•ˆæœã€‚

#### è¯·æ±‚å‚æ•°

```http
POST /api/v1/recommendation/behavior
Authorization: Bearer {token}
Content-Type: application/json
```

**Body å‚æ•°**

```json
{
  "itemId": "673c1a2f9d5f8e4b3c8a1234",
  "chapterId": "673c1a2f9d5f8e4b3c8a5678",
  "behaviorType": "read",
  "value": 300,
  "metadata": {
    "duration": 300,
    "progress": 0.15
  }
}
```

**å‚æ•°è¯´æ˜**

| å‚æ•°å       | ç±»å‹    | å¿…å¡« | è¯´æ˜                     |
| ------------ | ------- | ---- | ------------------------ |
| itemId       | string  | æ˜¯   | ä¹¦ç±ID                   |
| chapterId    | string  | å¦   | ç« èŠ‚IDï¼ˆé˜…è¯»è¡Œä¸ºæ—¶å¿…å¡«ï¼‰ |
| behaviorType | string  | æ˜¯   | è¡Œä¸ºç±»å‹                 |
| value        | float64 | å¦   | è¡Œä¸ºå¼ºåº¦ï¼ˆé»˜è®¤1.0ï¼‰      |
| metadata     | object  | å¦   | æ‰©å±•æ•°æ®                 |

**è¡Œä¸ºç±»å‹ (behaviorType)**

| ç±»å‹    | è¯´æ˜         | value å«ä¹‰     |
| ------- | ------------ | -------------- |
| view    | æµè§ˆä¹¦ç±è¯¦æƒ… | æµè§ˆæ—¶é•¿ï¼ˆç§’ï¼‰ |
| click   | ç‚¹å‡»ä¹¦ç±     | å›ºå®šä¸º 1.0     |
| collect | æ”¶è—ä¹¦ç±     | å›ºå®šä¸º 1.0     |
| read    | é˜…è¯»ç« èŠ‚     | é˜…è¯»æ—¶é•¿ï¼ˆç§’ï¼‰ |
| finish  | è¯»å®Œç« èŠ‚     | å›ºå®šä¸º 1.0     |
| like    | ç‚¹èµ         | å›ºå®šä¸º 1.0     |
| share   | åˆ†äº«         | å›ºå®šä¸º 1.0     |

#### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº” (200)**

```json
{
  "code": 200,
  "message": "è¡Œä¸ºè®°å½•æˆåŠŸ"
}
```

**é”™è¯¯å“åº” (400)**

```json
{
  "code": 400,
  "message": "ç¼ºå°‘å¿…å¡«å‚æ•°: itemId, behaviorType"
}
```

**é”™è¯¯å“åº” (401)**

```json
{
  "code": 401,
  "message": "æœªæˆæƒï¼Œè¯·å…ˆç™»å½•"
}
```

---

## ğŸ”§ æ¨èç®—æ³•è¯´æ˜

### 1. ä¸ªæ€§åŒ–æ¨èç®—æ³•

**åŸºäºç”¨æˆ·ç”»åƒ (User Profile Based)**

**ç®—æ³•æµç¨‹**:

1. è·å–ç”¨æˆ·ç”»åƒï¼ˆæ ‡ç­¾åå¥½ã€ä½œè€…åå¥½ã€åˆ†ç±»åå¥½ï¼‰
2. è®¡ç®—å€™é€‰ä¹¦ç±ä¸ç”¨æˆ·åå¥½çš„åŒ¹é…åº¦
3. æŒ‰åŒ¹é…åº¦æ’åºï¼Œè¿”å› Top-N

**åŒ¹é…åº¦è®¡ç®—**:

```
Score(user, book) = 
    w1 * Î£(user_tag_weight[tag] * book_tag_weight[tag]) +
    w2 * Î£(user_author_weight[author] * book_author_weight[author]) +
    w3 * Î£(user_category_weight[cat] * book_category_weight[cat])
```

**æƒé‡åˆ†é…**: w1=0.5, w2=0.3, w3=0.2

**å†·å¯åŠ¨ç­–ç•¥**:

- æ–°ç”¨æˆ·ï¼šæ¨èçƒ­é—¨ä¹¦ç±ï¼ˆæŒ‰é˜…è¯»é‡/æ”¶è—é‡æ’åºï¼‰
- æ— ç”»åƒï¼šåŸºäºå®æ—¶è¡Œä¸ºå¿«é€Ÿå»ºæ¨¡

### 2. ç›¸ä¼¼ç‰©å“æ¨èç®—æ³•

**åŸºäºç‰©å“çš„ååŒè¿‡æ»¤ (Item-Based Collaborative Filtering)**

**ç®—æ³•æµç¨‹**:

1. è·å–ç‰©å“ç‰¹å¾å‘é‡ï¼ˆæ ‡ç­¾ã€ä½œè€…ã€åˆ†ç±»ï¼‰
2. è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
3. è¿”å›æœ€ç›¸ä¼¼çš„ N ä¸ªç‰©å“

**ä½™å¼¦ç›¸ä¼¼åº¦**:

```
similarity(A, B) = cos(Î¸) = (A Â· B) / (||A|| * ||B||)
```

**ç‰¹å¾æƒé‡**:

- æ ‡ç­¾ï¼šæƒé‡ 0.6
- ä½œè€…ï¼šæƒé‡ 0.3
- åˆ†ç±»ï¼šæƒé‡ 0.1

---

## ğŸ“Š ç¼“å­˜ç­–ç•¥

### ä¸ªæ€§åŒ–æ¨èç¼“å­˜

- **ç¼“å­˜é”®**: `qingyu:reco:personalized:{userID}`
- **ç¼“å­˜å€¼**: ä¹¦ç±IDåˆ—è¡¨ï¼ˆJSONæ ¼å¼ï¼‰
- **è¿‡æœŸæ—¶é—´**: 1å°æ—¶
- **å¤±æ•ˆç­–ç•¥**: ç”¨æˆ·äº§ç”Ÿæ–°è¡Œä¸ºæ—¶æ¸…é™¤ç¼“å­˜

### ç›¸ä¼¼ç‰©å“ç¼“å­˜

- **ç¼“å­˜é”®**: `qingyu:reco:similar:{itemID}`
- **ç¼“å­˜å€¼**: ç›¸ä¼¼ä¹¦ç±IDåˆ—è¡¨ï¼ˆJSONæ ¼å¼ï¼‰
- **è¿‡æœŸæ—¶é—´**: 24å°æ—¶
- **å¤±æ•ˆç­–ç•¥**: ä¹¦ç±ç‰¹å¾æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜

---

## ğŸš€ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡       | ç›®æ ‡å€¼  | è¯´æ˜                 |
| ---------- | ------- | -------------------- |
| å“åº”æ—¶é—´   | < 200ms | åŒ…å«ç¼“å­˜å‘½ä¸­çš„æƒ…å†µ   |
| ç¼“å­˜å‘½ä¸­ç‡ | > 80%   | ä¸ªæ€§åŒ–æ¨èç¼“å­˜å‘½ä¸­ç‡ |
| æ¨èå‡†ç¡®ç‡ | > 20%   | ç”¨æˆ·ç‚¹å‡»ç‡           |
| æ¨èå¤šæ ·æ€§ | > 0.5   | é¿å…æ¨èè¿‡äºé›†ä¸­     |

---

## ğŸ” å®‰å…¨è¯´æ˜

### è®¤è¯

- ä¸ªæ€§åŒ–æ¨èéœ€è¦ç”¨æˆ·ç™»å½•ï¼Œä» JWT Token ä¸­æå– userID
- ç›¸ä¼¼ç‰©å“æ¨èä¸ºå…¬å¼€æ¥å£ï¼Œæ— éœ€è®¤è¯

### é™æµ

| æ¥å£       | é™æµç­–ç•¥   | è¯´æ˜               |
| ---------- | ---------- | ------------------ |
| ä¸ªæ€§åŒ–æ¨è | 10æ¬¡/åˆ†é’Ÿ  | é˜²æ­¢æ¶æ„åˆ·æ¨è     |
| ç›¸ä¼¼ç‰©å“   | 30æ¬¡/åˆ†é’Ÿ  | å…¬å¼€æ¥å£ï¼Œå®½æ¾é™æµ |
| è¡Œä¸ºè®°å½•   | 100æ¬¡/åˆ†é’Ÿ | æ”¯æŒé«˜é¢‘è¡Œä¸ºè®°å½•   |

### æ•°æ®éšç§

- ç”¨æˆ·è¡Œä¸ºæ•°æ®ä»…ç”¨äºæ¨èç®—æ³•ï¼Œä¸å¯¹å¤–å…¬å¼€
- ç”¨æˆ·ç”»åƒæ•°æ®åŠ å¯†å­˜å‚¨
- æ”¯æŒç”¨æˆ·åˆ é™¤ä¸ªäººè¡Œä¸ºæ•°æ®

---

## ğŸ“ è°ƒç”¨ç¤ºä¾‹

### JavaScript (Fetch API)

```javascript
// 1. è·å–ä¸ªæ€§åŒ–æ¨è
async function getPersonalizedRecommendations(limit = 10) {
  const response = await fetch(`/api/v1/recommendation/personalized?limit=${limit}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  return response.json();
}

// 2. è·å–ç›¸ä¼¼ç‰©å“
async function getSimilarItems(itemId, limit = 10) {
  const response = await fetch(`/api/v1/recommendation/similar?itemId=${itemId}&limit=${limit}`);
  return response.json();
}

// 3. è®°å½•ç”¨æˆ·è¡Œä¸º
async function recordBehavior(itemId, behaviorType, value) {
  const response = await fetch('/api/v1/recommendation/behavior', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      itemId,
      behaviorType,
      value
    })
  });
  return response.json();
}
```

### Go (net/http)

```go
// 1. è·å–ä¸ªæ€§åŒ–æ¨è
func GetPersonalizedRecommendations(token string, limit int) ([]string, error) {
    url := fmt.Sprintf("http://api.qingyu.com/api/v1/recommendation/personalized?limit=%d", limit)
    req, _ := http.NewRequest("GET", url, nil)
    req.Header.Set("Authorization", "Bearer "+token)
  
    resp, err := http.DefaultClient.Do(req)
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()
  
    // è§£æå“åº”...
}

// 2. è®°å½•ç”¨æˆ·è¡Œä¸º
func RecordBehavior(token, itemId, behaviorType string, value float64) error {
    body := map[string]interface{}{
        "itemId":       itemId,
        "behaviorType": behaviorType,
        "value":        value,
    }
    bodyBytes, _ := json.Marshal(body)
  
    req, _ := http.NewRequest("POST", "http://api.qingyu.com/api/v1/recommendation/behavior", bytes.NewReader(bodyBytes))
    req.Header.Set("Authorization", "Bearer "+token)
    req.Header.Set("Content-Type", "application/json")
  
    resp, err := http.DefaultClient.Do(req)
    // å¤„ç†å“åº”...
}
```

---

## ğŸ“ˆ åç»­ä¼˜åŒ–è®¡åˆ’

### çŸ­æœŸ

1. **ç®—æ³•å¢å¼º**

   - å®ç°æ··åˆæ¨èç®—æ³•ï¼ˆå¤šç®—æ³•èåˆï¼‰
   - å¢åŠ æ—¶é—´è¡°å‡å› å­ï¼ˆè¿‘æœŸè¡Œä¸ºæƒé‡æ›´é«˜ï¼‰
   - ä¼˜åŒ–å†·å¯åŠ¨ç­–ç•¥ï¼ˆå¤šç»´åº¦çƒ­é—¨ä¹¦ç±ï¼‰
2. **æ€§èƒ½ä¼˜åŒ–**

   - æ¨èç»“æœé¢„è®¡ç®—ï¼ˆæ¯å°æ—¶æ›´æ–°ï¼‰
   - ç¼“å­˜é¢„çƒ­ï¼ˆçƒ­é—¨ç”¨æˆ·ï¼‰
   - æ‰¹é‡æ¨èæ¥å£

### ä¸­æœŸ

3. **åŠŸèƒ½æ‰©å±•**

   - å®æ—¶æ¨èï¼ˆåŸºäºä¼šè¯ï¼‰
   - æ¨èè§£é‡Šï¼ˆä¸ºä»€ä¹ˆæ¨èè¿™æœ¬ä¹¦ï¼‰
   - A/Bæµ‹è¯•æ¡†æ¶
4. **ç®—æ³•å‡çº§**

   - æ·±åº¦å­¦ä¹ æ¨¡å‹é›†æˆ
   - å¤šè‡‚è€è™æœºï¼ˆæ¢ç´¢ vs åˆ©ç”¨ï¼‰
   - ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ¨èï¼ˆæ—¶é—´ã€åœ°ç‚¹ã€è®¾å¤‡ï¼‰

### é•¿æœŸ

5. **æ™ºèƒ½åŒ–**
   - å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–æ¨èç­–ç•¥
   - çŸ¥è¯†å›¾è°±å¢å¼ºæ¨è
   - è·¨é¢†åŸŸæ¨èï¼ˆä¹¦ç±+è§†é¢‘+éŸ³é¢‘ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-10-10
