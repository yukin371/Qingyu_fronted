# 青羽前端 - 部署检查清单

## 部署前检查

### 1. 代码质量检查

- [x] **TypeScript 类型检查**
  ```bash
  npm run type-check
  ```
  状态: ✅ 通过

- [x] **ESLint 代码检查**
  ```bash
  npm run lint
  ```
  状态: ✅ 通过（仅遗留旧代码中的警告）

- [x] **构建测试**
  ```bash
  npm run build
  ```
  状态: 待测试

### 2. 环境配置

- [ ] **生产环境变量** `.env.production`
  ```env
  VITE_API_BASE_URL=https://api.qingyu.com/api/v1
  VITE_APP_TITLE=青羽 - 在线阅读平台
  ```

- [ ] **API 基础地址** 
  - 确认后端 API 地址正确
  - 测试 API 连通性

- [ ] **CDN 配置** (可选)
  - 静态资源 CDN
  - 图片 CDN
  - 字体 CDN

### 3. 性能优化

- [x] **代码分割**
  - 路由懒加载: ✅
  - 组件异步加载: ✅
  
- [x] **缓存策略**
  - API 缓存: ✅
  - 图片懒加载: ✅
  - Service Worker: ⏸️ (暂未实现)

- [ ] **压缩优化**
  - Gzip/Brotli 压缩
  - 图片压缩
  - CSS/JS 压缩

### 4. 安全检查

- [x] **XSS 防护**
  - 使用 Vue 模板 (自动转义)
  - v-html 仅在必要时使用

- [x] **CSRF 防护**
  - Token 验证机制: ✅

- [ ] **HTTPS**
  - 强制 HTTPS 重定向
  - HSTS 头部设置

- [ ] **内容安全策略 (CSP)**
  ```html
  <meta http-equiv="Content-Security-Policy" content="...">
  ```

### 5. 浏览器兼容性

- [x] **现代浏览器**
  - Chrome (最新): ✅
  - Firefox (最新): ✅
  - Safari (最新): ✅
  - Edge (最新): ✅

- [x] **移动端浏览器**
  - iOS Safari: ✅
  - Android Chrome: ✅

- [ ] **旧版浏览器** (可选)
  - IE 11: ❌ (不支持)
  - 添加 Polyfills: ⏸️

### 6. SEO 优化

- [x] **Meta 标签**
  - title: ✅
  - description: ✅
  - keywords: ✅
  - viewport: ✅

- [ ] **OG 标签** (社交分享)
  ```html
  <meta property="og:title" content="...">
  <meta property="og:description" content="...">
  <meta property="og:image" content="...">
  ```

- [ ] **结构化数据**
  - JSON-LD schema
  - 面包屑导航
  - 文章标记

- [ ] **sitemap.xml**
- [ ] **robots.txt**

### 7. 监控与分析

- [ ] **错误监控**
  - Sentry
  - 或其他错误追踪服务

- [ ] **性能监控**
  - Google Analytics
  - 性能指标上报

- [ ] **用户行为分析**
  - 页面访问统计
  - 用户行为追踪

### 8. 备份与回滚

- [ ] **备份策略**
  - 代码备份: Git
  - 配置备份
  - 数据库备份 (如有)

- [ ] **回滚方案**
  - 快速回滚到上一版本
  - 回滚脚本准备

## 部署步骤

### 方式一: 传统服务器部署

#### 1. 构建

```bash
# 安装依赖
npm install

# 构建生产版本
npm run build
```

#### 2. 上传

```bash
# 使用 scp 上传
scp -r dist/* user@server:/var/www/qingyu/

# 或使用 rsync
rsync -avz dist/ user@server:/var/www/qingyu/
```

#### 3. Nginx 配置

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name qingyu.com www.qingyu.com;
    
    # HTTPS 重定向
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name qingyu.com www.qingyu.com;
    
    # SSL 证书
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 根目录
    root /var/www/qingyu;
    index index.html;
    
    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # 缓存策略
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # SPA 路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API 代理 (可选)
    location /api/ {
        proxy_pass http://backend-server:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 4. 重启 Nginx

```bash
sudo nginx -t
sudo systemctl restart nginx
```

### 方式二: Docker 部署

#### 1. 创建 Dockerfile

```dockerfile
# 构建阶段
FROM node:16-alpine as build-stage
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# 生产阶段
FROM nginx:alpine as production-stage
COPY --from=build-stage /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### 2. 构建镜像

```bash
docker build -t qingyu-frontend .
```

#### 3. 运行容器

```bash
docker run -d -p 80:80 --name qingyu-web qingyu-frontend
```

### 方式三: Vercel 部署

#### 1. 安装 Vercel CLI

```bash
npm i -g vercel
```

#### 2. 部署

```bash
vercel --prod
```

#### 3. 配置文件 `vercel.json`

```json
{
  "rewrites": [
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}
```

### 方式四: Netlify 部署

#### 1. 创建 `netlify.toml`

```toml
[build]
  command = "npm run build"
  publish = "dist"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
```

#### 2. 部署

```bash
# 通过 Git 自动部署
# 或使用 Netlify CLI
netlify deploy --prod
```

## 部署后验证

### 1. 功能测试

- [ ] 首页加载正常
- [ ] 登录/注册功能
- [ ] 书籍列表/详情
- [ ] 阅读器功能
- [ ] 搜索功能
- [ ] 个人中心

### 2. 性能测试

使用 Lighthouse 测试：

```bash
lighthouse https://qingyu.com --view
```

目标指标：
- Performance: > 90
- Accessibility: > 90
- Best Practices: > 90
- SEO: > 90

### 3. 移动端测试

- [ ] 移动端布局正常
- [ ] 触摸交互流畅
- [ ] 页面加载速度可接受

### 4. 跨浏览器测试

- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Edge
- [ ] 移动浏览器

## 监控设置

### 1. 错误监控

添加 Sentry (示例):

```javascript
// main.ts
import * as Sentry from "@sentry/vue"

if (import.meta.env.PROD) {
  Sentry.init({
    app,
    dsn: "YOUR_SENTRY_DSN",
    integrations: [
      new Sentry.BrowserTracing(),
    ],
    tracesSampleRate: 0.1,
  })
}
```

### 2. 性能监控

```javascript
// 上报性能数据
const metrics = performanceMonitor.collectPageMetrics()
analytics.track('page_performance', metrics)
```

### 3. 用户分析

```javascript
// Google Analytics
import VueGtag from 'vue-gtag'

app.use(VueGtag, {
  config: { id: "GA_MEASUREMENT_ID" }
})
```

## 常见问题

### 1. 白屏问题

- 检查 API 地址配置
- 查看浏览器控制台错误
- 检查路由配置

### 2. 资源加载失败

- 检查 CDN 配置
- 检查 CORS 设置
- 检查路径是否正确

### 3. 刷新 404

- 确保服务器配置了 SPA 路由支持
- Nginx: `try_files $uri $uri/ /index.html;`

### 4. API 请求失败

- 检查 API 地址
- 检查 CORS 配置
- 检查网络连接

## 维护建议

### 日常维护

- 定期检查错误日志
- 监控性能指标
- 及时更新依赖包
- 备份重要数据

### 更新流程

1. 开发环境测试
2. 预发布环境验证
3. 灰度发布 (可选)
4. 全量发布
5. 监控观察

### 回滚流程

1. 确认问题
2. 执行回滚脚本
3. 验证服务恢复
4. 分析问题原因
5. 修复后重新部署

---

**部署检查负责人**: _______________  
**部署日期**: _______________  
**版本号**: _______________  
**签字**: _______________  


