name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

jobs:
  pr-check:
    name: Pull Request Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run tests
        run: npm run test:run

      - name: Generate coverage
        run: npm run test:coverage

      - name: Check coverage threshold
        id: coverage-check
        run: |
          echo "Checking coverage threshold..."

          # Read coverage summary if available
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "Coverage summary found"
            # Add actual coverage parsing logic here based on your coverage tool output
          else
            echo "Coverage summary not found, skipping detailed check"
          fi

          echo "‚úÖ All tests passed"
          echo "‚ö†Ô∏è Coverage threshold check: Placeholder (requires actual coverage data)"

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const comment = `## ü§ñ CI/CD Test Results

            ### ‚úÖ Tests
            All unit tests passed successfully!

            ### üìä Coverage
            Coverage report generated. Check the artifacts for detailed report.

            ### üîó Links
            - [View Coverage Report](https://codecov.io/gh/${{ github.repository }})
            - [Build Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            _This comment was automatically generated by CI/CD pipeline._
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            })

      - name: PR check status
        run: |
          echo "‚úÖ PR check passed"
          echo "Note: Coverage threshold enforcement requires actual coverage data integration"

  lint:
    name: Lint Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run linting (if configured)
        run: |
          if grep -q '"lint"' package.json; then
            npm run lint
          else
            echo "‚ö†Ô∏è No lint script found, skipping"
          fi
        continue-on-error: true

      - name: Type check (if configured)
        run: |
          if grep -q '"type-check"' package.json; then
            npm run type-check
          else
            echo "‚ö†Ô∏è No type-check script found, skipping"
          fi
        continue-on-error: true
